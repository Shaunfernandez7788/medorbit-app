{% extends "base.html" %}

{% block content %}
<style>
    /* --- CUSTOM RESULT BOX COLORS --- */
    .st-green { background-color: #1c4f2e; color: #4ade80; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #225c34; }
    .st-blue { background-color: #142d4c; color: #dbeafe; padding: 20px; border-radius: 5px; height: 100%; border-left: 5px solid #3b82f6; }
    .st-blue h5 { color: #60a5fa; font-weight: bold; margin-bottom: 15px; }
    .st-yellow { background-color: #3f3615; color: #fef3c7; padding: 20px; border-radius: 5px; height: 100%; border-left: 5px solid #eab308; }
    .st-yellow h5 { color: #facc15; font-weight: bold; margin-bottom: 15px; }

    /* --- TAG INPUT STYLING --- */
    .input-wrapper { position: relative; }

    .search-container {
        background-color: #262730;
        border: 1px solid #41444C;
        border-radius: 5px;
        padding: 5px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        min-height: 45px;
        cursor: text;
    }
    .search-container:focus-within {
        border-color: #FF4B4B;
        box-shadow: 0 0 0 0.2rem rgba(255, 75, 75, 0.25);
    }

    .search-input {
        background: transparent;
        border: none;
        color: white;
        flex-grow: 1;
        min-width: 120px;
        outline: none;
        padding: 4px 8px;
        font-size: 1rem;
    }

    .tag {
        background-color: #FF4B4B;
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        animation: fadeIn 0.2s;
    }
    .tag span.remove-btn {
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        line-height: 1;
        opacity: 0.8;
    }
    .tag span.remove-btn:hover { opacity: 1; color: #000; }

    .suggestions-list {
        background-color: #262730;
        border: 1px solid #41444C;
        border-top: none;
        max-height: 250px;
        overflow-y: auto;
        border-radius: 0 0 5px 5px;
        display: none;
        position: absolute;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        color: #e0e0e0;
        transition: background 0.2s;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: #FF4B4B; color: white; }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
</style>

<div class="row">
    <div class="col-md-12">
        <h2 class="mb-3">ü©∫ AI Health Assistant</h2>
        <p class="text-secondary mb-4">Select your symptoms below to get a preliminary analysis.</p>
    </div>
</div>

<div class="row">
    
    <div class="col-md-5">
        <div class="card mb-4" style="overflow: visible;">
            <div class="card-header">üîé Symptom Selector</div>
            <div class="card-body">
                <form method="POST" action="/predict" id="healthForm">
                    
                    <select name="symptoms" id="realSelect" multiple style="display: none;"></select>

                    <label class="form-label text-light mb-2">What are your symptoms?</label>
                    
                    <div class="input-wrapper">
                        <div class="search-container">
                            <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                            
                            <input type="text" id="symptomInput" class="search-input" placeholder="Type or click üé§..." autocomplete="off">
                            
                            <button type="button" onclick="startDictation()" class="btn btn-sm btn-link text-decoration-none" title="Speak">
                                üé§
                            </button>
                        </div>
                        <div id="suggestions" class="suggestions-list"></div>
                    </div>

                    <button type="submit" class="btn btn-primary mt-4 w-100 py-2 fw-bold">Analyze Health</button>
                </form>

                <button type="button" onclick="openGoogleMaps()" class="btn btn-outline-info mt-3 w-100 py-2 fw-bold">
                    üè• Find Hospitals on Map (Real)
                </button>

                <button type="button" onclick="showMockBooking()" class="btn btn-outline-warning mt-2 w-100 py-2 fw-bold">
                    üìÖ Book Appointment (Demo)
                </button>
            </div>
        </div>

        {% if appointments %}
        <div class="card mb-4" id="my-appointments-section">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span>üìÖ My Appointments</span>
                <span class="badge bg-light text-dark">{{ appointments|length }} Upcoming</span>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for appt in appointments %}
                    <li class="list-group-item bg-dark text-light border-secondary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="text-info">{{ appt.hospital_name }}</strong><br>
                                <small class="text-muted">
                                    üóìÔ∏è <span id="date-{{appt.id}}">{{ appt.date }}</span> ‚Ä¢ 
                                    ‚è∞ <span id="time-{{appt.id}}">{{ appt.time }}</span>
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal('{{appt.id}}', '{{appt.date}}', '{{appt.time}}')">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment('{{appt.id}}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-7">
        
        {% if prediction %}
        <div class="st-green">
            <h4 class="m-0">Predicted Condition: {{ prediction }}</h4>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="st-blue">
                    <h5>What is it?</h5>
                    <p class="mb-0 text-light">{{ description }}</p>
                </div>
            </div>

            <div class="col-md-12">
                <div class="st-yellow">
                    <h5>Recommended Precautions:</h5>
                    <ul class="mb-0 ps-3">
                        {% for p in precautions %}
                            <li class="text-light mb-1">{{ p.title() }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="hospital-results" class="mt-4" style="display:none;">
            <h4 class="text-light mb-3">üè• Select a Hospital to Book</h4>
            <div id="hospital-list" class="row"></div>
        </div>

    </div>

</div> 

<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Book Appointment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="selectedHospital">
        <div class="mb-3">
            <label>Hospital Name</label>
            <input type="text" id="hospitalNameDisplay" class="form-control bg-secondary text-light" disabled>
        </div>
        <div class="mb-3">
            <label>Date</label>
            <input type="date" id="bookDate" class="form-control bg-dark text-light border-secondary">
        </div>
        <div class="mb-3">
            <label>Time</label>
            <input type="time" id="bookTime" class="form-control bg-dark text-light border-secondary">
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" onclick="confirmBooking()" class="btn btn-success">Confirm Booking</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">‚úèÔ∏è Reschedule Appointment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label>New Date</label>
            <input type="date" id="editDate" class="form-control bg-dark text-light border-secondary">
        </div>
        <div class="mb-3">
            <label>New Time</label>
            <input type="time" id="editTime" class="form-control bg-dark text-light border-secondary">
        </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" onclick="saveEdit()" class="btn btn-warning">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
    // --- SYMPTOM SEARCH LOGIC ---
    const allSymptoms = {{ symptoms | tojson | safe }};
    let selectedSymptoms = [];

    const input = document.getElementById('symptomInput');
    const suggestionsBox = document.getElementById('suggestions');
    const tagsContainer = document.getElementById('tagsContainer');
    const realSelect = document.getElementById('realSelect');

    function renderSuggestions(filterText = '') {
        suggestionsBox.innerHTML = ''; 
        const filtered = allSymptoms.filter(s => 
            !selectedSymptoms.includes(s) && 
            s.toLowerCase().replace('_', ' ').includes(filterText.toLowerCase())
        );

        if (filtered.length > 0) {
            suggestionsBox.style.display = 'block';
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = s.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); 
                div.onclick = () => addSymptom(s);
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    }

    function addSymptom(symptom) {
        selectedSymptoms.push(symptom);
        input.value = ''; 
        renderTags();
        renderSuggestions(''); 
        updateHiddenSelect();
        input.focus(); 
    }

    function removeSymptom(symptom) {
        selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
        renderTags();
        updateHiddenSelect();
    }

    function renderTags() {
        tagsContainer.innerHTML = '';
        selectedSymptoms.forEach(s => {
            const tag = document.createElement('div');
            tag.className = 'tag';
            const text = document.createElement('span');
            text.textContent = s.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const cross = document.createElement('span');
            cross.className = 'remove-btn';
            cross.innerHTML = '√ó';
            cross.onclick = (e) => {
                e.stopPropagation(); 
                removeSymptom(s);
            };
            tag.appendChild(text);
            tag.appendChild(cross);
            tagsContainer.appendChild(tag);
        });
    }

    function updateHiddenSelect() {
        realSelect.innerHTML = '';
        selectedSymptoms.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.selected = true;
            realSelect.appendChild(option);
        });
    }

    input.addEventListener('input', (e) => renderSuggestions(e.target.value));
    input.addEventListener('click', () => renderSuggestions(input.value));
    input.addEventListener('focus', () => renderSuggestions(input.value));
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-wrapper')) {
            suggestionsBox.style.display = 'none';
        }
    });

    // --- FUNCTION 1: REAL GOOGLE MAPS (Opens in New Tab) ---
    function openGoogleMaps() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                // Opens a real Google Maps search centered on the user
                const url = `https://www.google.com/maps/search/hospitals/@${lat},${lon},14z`;
                window.open(url, "_blank");
            }, () => {
                // Fallback if location denied
                window.open("https://www.google.com/maps/search/hospitals/", "_blank");
            });
        } else {
            alert("Geolocation is not supported by this browser.");
            window.open("https://www.google.com/maps/search/hospitals/", "_blank");
        }
    }

    // --- FUNCTION 2: SHOW MOCK HOSPITALS (For Booking Demo) ---
    function showMockBooking() {
        document.getElementById('hospital-results').style.display = 'block';
        const list = document.getElementById('hospital-list');
        list.innerHTML = ''; // Clear previous

        // Imaginary Hospital List
        const mockHospitals = [
            { name: "MedOrbit General Hospital", dist: "1.2 km", type: "General" },
            { name: "Apollo Mock Clinic", dist: "2.5 km", type: "Clinic" },
            { name: "Sunrise Demo Care", dist: "3.0 km", type: "Specialist" },
            { name: "City Trauma Center", dist: "4.1 km", type: "Emergency" }
        ];

        mockHospitals.forEach(h => {
            list.innerHTML += `
            <div class="col-md-6 mb-3">
                <div class="card bg-dark border-secondary p-3 h-100">
                    <h5 class="text-info">${h.name}</h5>
                    <p class="text-muted mb-2">üìç ${h.dist} away ‚Ä¢ ${h.type}</p>
                    <button class="btn btn-sm btn-success w-100 mt-auto" onclick="openBooking('${h.name}')">
                        üìÖ Book Appointment
                    </button>
                </div>
            </div>`;
        });
    }

    // --- BOOKING MODAL LOGIC ---
    function openBooking(hospitalName) {
        document.getElementById('selectedHospital').value = hospitalName;
        document.getElementById('hospitalNameDisplay').value = hospitalName;
        new bootstrap.Modal(document.getElementById('bookingModal')).show();
    }

    async function confirmBooking() {
        const hospital = document.getElementById('selectedHospital').value;
        const date = document.getElementById('bookDate').value;
        const time = document.getElementById('bookTime').value;

        if(!date || !time) {
            alert("Please select a date and time!");
            return;
        }

        const response = await fetch('/book_appointment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hospital_name: hospital, date: date, time: time })
        });

        const result = await response.json();
        alert(result.message);
        
        if(result.status === 'success') {
            window.location.reload(); 
        }
    }

    // --- NEW: EDIT & DELETE LOGIC ---
    let editingId = null;

    function openEditModal(id, oldDate, oldTime) {
        editingId = id;
        document.getElementById('editDate').value = oldDate;
        document.getElementById('editTime').value = oldTime;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    async function saveEdit() {
        const date = document.getElementById('editDate').value;
        const time = document.getElementById('editTime').value;

        const response = await fetch(`/edit_appointment/${editingId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date, time: time })
        });

        const result = await response.json();
        alert(result.message);
        location.reload();
    }

    async function deleteAppointment(id) {
        if(confirm("Are you sure you want to cancel this appointment?")) {
            const response = await fetch(`/delete_appointment/${id}`, {
                method: 'POST'
            });
            const result = await response.json();
            alert(result.message);
            location.reload();
        }
    }

    // --- VOICE RECOGNITION (Added Previously) ---
    function startDictation() {
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";
            recognition.start();

            const input = document.getElementById('symptomInput');
            const originalPlaceholder = input.placeholder;
            input.placeholder = "Listening... üî¥";

            recognition.onresult = function(e) {
                const transcript = e.results[0][0].transcript;
                input.value = transcript;
                input.placeholder = originalPlaceholder;
                renderSuggestions(transcript);
                input.focus();
            };

            recognition.onerror = function(e) {
                console.error(e);
                input.placeholder = "Error. Try again.";
                setTimeout(() => input.placeholder = originalPlaceholder, 2000);
                recognition.stop();
            };
        } else {
            alert("Voice recognition is not supported in this browser. Please use Chrome or Edge.");
        }
    }
</script>
{% endblock %}